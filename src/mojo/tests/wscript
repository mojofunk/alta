#! /usr/bin/env python
# encoding: utf-8
# Tim Mayberry, 2008

tests = '''
test_application
test_core_initialize
test_debug
test_resource
test_sequence
test_spinwait
test_state_tracker
test_string_convert
test_string_compose
test_timing
test_type_system
test_graph
test_module_utils
test_project
test_audio_clip
test_filesystem_paths
test_project_directory
test_file_utils
test_archive_modules
test_audiofile_modules
test_audio_driver_modules
test_audio_effect_modules
test_midi_driver_modules
'''.split()

all_test_sources = []

for test in tests:
    all_test_sources.append(test + '.cpp')

common_sources = ['test_common.cpp', 'example_application.cpp']

uselibs = [
    'BOOST_UNIT_TEST_FRAMEWORK',
    'BOOST_FILESYSTEM',
    'BOOST_SYSTEM',
    'GLIB-2.0',
    'GMODULE-2.0']

use_shared = [
    'MOJO_CORE_SHARED',
    'MOJO_ENGINE_SHARED',
    'MOJO_APPLICATION_SHARED']

use_static = [
    'MOJO_CORE_STATIC',
    'MOJO_ENGINE_STATIC',
    'MOJO_APPLICATION_STATIC']


def init():
    pass


def configure(conf):
    if not conf.env.BUILD_TESTS:
        return

    print ("configure mojo tests")


def build_single_tests_shared(bld):
    bld.shlib(
        source=common_sources,
        includes='.',
        defines='BOOST_TEST_DYN_LINK=1',
        uselib=uselibs,
        use=use_shared,
        target='mojo-test-common-shared',
        name='MOJO_TEST_COMMON_SHARED')

    for test in tests:
        bld.program(
            source=test + '.cpp',
            includes='.',
            defines='BOOST_TEST_DYN_LINK=1',
            uselib=uselibs,
            use=use_shared + ['MOJO_TEST_COMMON_SHARED'],
            target=test)


def build_tests_shared(bld):
    defines = ['BOOST_TEST_DYN_LINK=1',
               'MOJO_SINGLE_TEST_EXE=1']
    if bld.env.ENABLE_AMALGAMATION:
        defines += ['MOJO_TEST_AMALGAMATED']
        source = ['test_main.cpp']
    else:
        source = all_test_sources + common_sources + ['test_main.cpp']

    bld.program(
        includes='.',
        source=source,
        defines=defines,
        uselib=uselibs,
        use=use_shared,
        target='mojo-tests')


def build_shared(bld):
    if bld.env.SINGLE_TESTS:
        build_single_tests_shared(bld)
    else:
        build_tests_shared(bld)


def build_single_tests_static(bld):
    bld.stlib(
        source=common_sources,
        includes='.',
        defines='BOOST_TEST_DYN_LINK=1',
        uselib=uselibs,
        use=use_static,
        target='mojo-test-common-static',
        name='MOJO_TEST_COMMON_STATIC')

    for test in tests:
        bld.program(
            source=test + '.cpp',
            includes='.',
            defines='BOOST_TEST_DYN_LINK=1',
            uselib=uselibs,
            use=use_static + ['MOJO_TEST_COMMON_STATIC'],
            target=test + '-static')


def build_tests_static(bld):
    defines = ['BOOST_TEST_DYN_LINK=1',
               'MOJO_SINGLE_TEST_EXE=1']
    if bld.env.ENABLE_AMALGAMATION:
        defines += ['MOJO_TEST_AMALGAMATED']
        source = ['test_main.cpp']
    else:
        source = all_test_sources + common_sources + ['test_main.cpp']

    bld.program(
        includes='.',
        source=source,
        defines=defines,
        uselib=uselibs,
        use=use_static,
        target='mojo-tests-static')


def build_static(bld):
    if bld.env.SINGLE_TESTS:
        build_single_tests_static(bld)
    else:
        build_tests_static(bld)


def build(bld):
    if not bld.env.BUILD_TESTS:
        return

    if bld.env.ENABLE_SHARED:
        build_shared(bld)

    if bld.env.ENABLE_STATIC:
        build_static(bld)
